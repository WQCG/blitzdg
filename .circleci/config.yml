version: 2
jobs:
  build:
    branches:
      ignore:
        - gh-pages
    docker:
      - image: dsteinmoeller/blitzdg-circle:0.15

    steps:
      - checkout
      - run:
          name: Pull git submodules
          command: |
            git submodule update --init --recursive
      - run:
          name: Generate makefiles
          command: |
            DEBUG=1 CXX=clang++ INC="-I /opt/blitzpp/blitz-1.0.1" cmake .
      - run:
          name: Build (clang)
          command: |
            DEBUG=1 CXX=clang++ INC="-I /opt/blitzpp/blitz-1.0.1" make -j4
            make clean
            rm -rf CMakeFiles/ CMakeCache.txt
      - run:
          name: Build (gcc)
          command: |
            DEBUG=1 CXX='g++ -Og' INC="-I /opt/blitzpp/blitz-1.0.1" cmake .
            DEBUG=1 CXX='g++ -Og' INC="-I /opt/blitzpp/blitz-1.0.1" make -j4
      - run:
          name: Test
          command: bin/test
      - run:
          name: Code Coverage
          command: coveralls --exclude include/igloo --gcov-options '\-lp'
